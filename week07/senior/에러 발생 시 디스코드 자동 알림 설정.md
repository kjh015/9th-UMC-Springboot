# ì—ëŸ¬ ë°œìƒ ì‹œ ë””ìŠ¤ì½”ë“œ ìë™  ì•Œë¦¼ ì„¤ì •

# **ë””ìŠ¤ì½”ë“œ ì›¹í›…(Webhook) ì„¤ì •**

---

- ë””ìŠ¤ì½”ë“œ í˜¹ì€ ìŠ¬ë™ì—ì„œ **Webhook URL ìƒì„±**.

![1_WebhookURL.png](1_WebhookURL.png)

# **ì˜ˆì™¸ í•¸ë“¤ëŸ¬ë¥¼ í†µí•´ 500 ì—ëŸ¬ ê°ì§€**

---

- `@ControllerAdvice` 500ì—ëŸ¬ë¥¼ íƒì§€í•˜ëŠ” ê³³ì— discordë‚˜ ìŠ¬ë™ì— ë³´ë‚´ëŠ” ì½”ë“œë¥¼ ì‘ì„±
- ë°œìƒí•œ ì˜ˆì™¸ ë©”ì‹œì§€, ìš”ì²­ URL, ë°œìƒ ì‹œê° ë“±ì˜ ì •ë³´ë¥¼ í¬í•¨í•œ **ì—ëŸ¬ ë¡œê·¸ í¬ë§· ì •ì˜**.
- **ë””ìŠ¤ì½”ë“œ**ë‚˜ **ìŠ¬ë™**ì— **POST ìš”ì²­**ì„ ë³´ë‚´ëŠ” **ì½”ë“œ ì‘ì„±** (ì´ë•Œ Webhook URLì´ ìœ ì¶œë˜ì§€ ì•Šê²Œê¸ˆ ì£¼ì˜í•œë‹¤.)

`RestTemplate`ì„ ì‚¬ìš©í•˜ì—¬ 500ì—ëŸ¬ ë°œìƒ ì‹œ  **ë””ìŠ¤ì½”ë“œ WebhookURL**ì— **POST ìš”ì²­**ì„ ë³´ë‚¸ë‹¤.

```java
package com.example.umc9th.global.service;

import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.http.HttpEntity;
import org.springframework.http.HttpHeaders;
import org.springframework.http.MediaType;
import org.springframework.stereotype.Service;
import org.springframework.web.client.RestTemplate;

import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;
import java.util.Map;

@Service
@RequiredArgsConstructor
@Slf4j
public class DiscordWebhookService {
    //Webhook URLì„ í™˜ê²½ë³€ìˆ˜ì— ì €ì¥
    @Value("${alert.discord.webhook-url}")
    private String webhookUrl;

    //localí™˜ê²½ì´ë©´ enabled:false, deví™˜ê²½ì´ë©´ enabled:true
    @Value("${alert.discord.enabled}")
    private boolean webhookEnabled;

    //Spring Frameworkì—ì„œ ì œê³µí•˜ëŠ” ë™ê¸°(Synchronous) ë°©ì‹ì˜ HTTP í´ë¼ì´ì–¸íŠ¸
    //ë‹¤ë¥¸ ì„œë²„ì˜ APIë¥¼ í˜¸ì¶œí•  ë•Œ ì‚¬ìš©
    private final RestTemplate restTemplate = new RestTemplate();

    public void sendErrorToWebhook(Exception ex, String url, String method) {
        try {
            if(webhookEnabled){
                String message = buildMessage(ex, url, method);

                //HTTP Header ì •ì˜, Content-Type: application/json
                HttpHeaders headers = new HttpHeaders();
                headers.setContentType(MediaType.APPLICATION_JSON);

                // Discord body í˜•ì‹({content: ë‚´ìš©})
                Map<String, String> payload = Map.of("content", message);

                //header + body
                HttpEntity<Map<String, String>> entity = new HttpEntity<>(payload, headers);

                //webhookUrlì— entityë‚´ìš©ì„ postë¡œ ì „ì†¡
                restTemplate.postForEntity(webhookUrl, entity, String.class);
            }

        } catch (Exception e) {
            log.error("Failed to send webhook: {}", e.getMessage());
        }
    }

    // Discordì— ë³´ë‚¼ ë©”ì‹œì§€ í˜•ì‹
    private String buildMessage(Exception ex, String url, String method) {
        return """
                ğŸš¨ **500 Internal Server Error ë°œìƒ**
                - URL: `%s`
                - Method: `%s`
                - ì˜ˆì™¸: `%s`
                - ì‹œê°: `%s`
                """.formatted(
                url,
                method,
                ex.getMessage(),
                LocalDateTime.now().format(DateTimeFormatter.ofPattern("yyyy-MM-dd HH:mm:ss"))
        );
    }

}

```

```java
package com.example.umc9th.global.apiPayload.handler;

import com.example.umc9th.global.apiPayload.ApiResponse;
import com.example.umc9th.global.apiPayload.code.BaseErrorCode;
import com.example.umc9th.global.apiPayload.code.GeneralErrorCode;
import com.example.umc9th.global.apiPayload.exception.GeneralException;
import com.example.umc9th.global.service.DiscordWebhookService;
import jakarta.servlet.http.HttpServletRequest;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.ExceptionHandler;
import org.springframework.web.bind.annotation.RestControllerAdvice;

@RestControllerAdvice
@RequiredArgsConstructor
@Slf4j
public class GeneralExceptionAdvice {

    private final DiscordWebhookService discordWebhookService;
    
    ...

    // ê·¸ ì™¸ì˜ ì •ì˜ë˜ì§€ ì•Šì€ ëª¨ë“  ì˜ˆì™¸ ì²˜ë¦¬
    @ExceptionHandler(Exception.class)
    public ResponseEntity<ApiResponse<String>> handleException(Exception ex, HttpServletRequest request){

				// ì˜¤ë¥˜ë‚œ urlê³¼ httpMethod ê°€ì ¸ì˜¤ê¸°
        String url = request.getRequestURI();
        String method = request.getMethod();

        // ë¡œê·¸ ì¶œë ¥
        log.error("[500 ERROR] {} {} - {}", method, url, ex.getMessage(), ex);

        // ì›¹í›…ìœ¼ë¡œ ì „ì†¡
        discordWebhookService.sendErrorToWebhook(ex, url, method);

        BaseErrorCode code = GeneralErrorCode.INTERNAL_SERVER_ERROR;
        return ResponseEntity.status(code.getStatus())
                .body(ApiResponse.onFailure(code, ex.getMessage()));
    }

}

```

```yaml
spring:
  application:
    name: "UMC9th" # "umc9th"

...

alert:
  discord:
    webhook-url: ${DISCORD_WEBHOOK_URL}
    enabled: false
```

![í™˜ê²½ ë³€ìˆ˜ì— Webhook URL ì¶”ê°€](2_%ED%99%98%EA%B2%BD%EB%B3%80%EC%88%98.png)

í™˜ê²½ ë³€ìˆ˜ì— Webhook URL ì¶”ê°€

Webhook URLê°€ ìœ ì¶œë˜ì§€ ì•Šê²Œ í•˜ê¸° ìœ„í•´ í™˜ê²½ ë³€ìˆ˜ì— ì €ì¥í•˜ê³  application.ymlì—ì„œ ì‚¬ìš©í•œë‹¤.

# **ì—ëŸ¬ ë°œìƒ ì‹œ ì•Œë¦¼ í…ŒìŠ¤íŠ¸**

---

- ê°•ì œë¡œ 500 ì—ëŸ¬ë¥¼ ë°œìƒì‹œí‚¤ëŠ” API ì—”ë“œí¬ì¸íŠ¸ë¥¼ êµ¬í˜„í•˜ê³  **ì •ìƒì ìœ¼ë¡œ ì•Œë¦¼ì´ ì „ì†¡ë˜ëŠ”ì§€ í…ŒìŠ¤íŠ¸**.

```java
package com.example.umc9th.domain.test.controller;

@RestController
@RequiredArgsConstructor
@RequestMapping("/temp")
public class TestController {
		
		...

    @GetMapping("/webhook")
    public ApiResponse<TestResDTO.Testing> webhookTest(){
        try{
            throw new Exception();
        } catch (Exception e) {
            throw new RuntimeException(e);
        }
    }
}

```

![Postman](3_Postman.png)

Postman

![Discord](4_Discord.png)

Discord

# **ê°œë°œ ì„œë²„, ë¡œì»¬ ì„œë²„** ì•Œë¦¼ ë¶„ë¦¬

- **ê°œë°œ ì„œë²„(or ìš´ì˜ ì„œë²„) í™˜ê²½**ì—ì„œë§Œ ì•Œë¦¼ì´ ì˜¤ë„ë¡ **ì„¤ì •**
    - ë§Œì•½ ë¡œì»¬ ì„œë²„ì—ì„œ ë‚œ ì—ëŸ¬ë„ ì•Œë¦¼ì´ ê°€ê²Œ í•œë‹¤ë©´ íŒ€ í˜‘ì—… ì‹œ ì–´ë– í•œ ì¼ì´ ì¼ì–´ë‚  ì§€ ìƒê° í•´ë³¸ë‹¤.

```yaml
spring:
  application:
    name: "UMC9th" # "umc9th"

  datasource:
    driver-class-name: com.mysql.cj.jdbc.Driver # MySQL JDBC ???? ??? ??
    url: ${DB_URL} # jdbc:mysql://localhost:3306/{???????}
    username: ${DB_USER} # MySQL ?? ??
    password: ${DB_PW} # MySQL ????

  jpa:
    database: mysql # ??? ?????? ?? ?? (MySQL)
    database-platform: org.hibernate.dialect.MySQLDialect # Hibernate?? ??? MySQL ??(dialect) ??
    show-sql: true # ??? SQL ??? ??? ???? ?? ??
    hibernate:
      ddl-auto: update # ?????? ?? ? ?????? ???? ??? ??
    properties:
      hibernate:
        format_sql: true # ???? SQL ??? ?? ?? ???

alert:
  discord:
    webhook-url: ${DISCORD_WEBHOOK_URL}
    enabled: false
```

```yaml
alert:
  discord:
    enabled: true
```

```yaml
alert:
  discord:
    enabled: false
```

ë¡œì»¬í™˜ê²½ê³¼ ê°œë°œí™˜ê²½ì„ êµ¬ë¶„í•˜ê¸° ìœ„í•´ ê¸°ì¡´ì˜ `application.yml`ì— ë”í•´ `application-dev.yml`, `application-local.yml` íŒŒì¼ì„ ì¶”ê°€í•œë‹¤.

![application-{profile}.yml](5_yml.png)

application-{profile}.yml

![í™œì„±í™”ëœ í”„ë¡œíŒŒì¼(Active Profiles): dev](6_activeProfile.png)

í™œì„±í™”ëœ í”„ë¡œíŒŒì¼(Active Profiles): dev

SpringBootì—ì„œëŠ” `application-{profile}.yml` í˜•ì‹ìœ¼ë¡œ **profile**ì„ êµ¬ë¶„í•  ìˆ˜ ìˆë‹¤.

êµ¬ì„±ì—ì„œ **í˜„ì¬ profileì„ devë¡œ ì„¤ì •**í•œë‹¤ë©´, ê¸°ì¡´ `appllication.yml`ê³¼ `application-dev.yml` ë‘ íŒŒì¼ì„ **ì¸ì‹**í•œë‹¤.

- ë§Œì•½ `application.yml`ê³¼ `application-dev.ym`lì— ê°™ì€ ì„¤ì •ì´ ìˆë‹¤ë©´ `application-dev.yml`ì˜ ì„¤ì •ì„ ì‚¬ìš©í•œë‹¤ (**ë®ì–´ì“°ê¸°**)

```java
package com.example.umc9th.global.service;

@Service
@RequiredArgsConstructor
@Slf4j
public class DiscordWebhookService {
    //Webhook URLì„ í™˜ê²½ë³€ìˆ˜ì— ì €ì¥
    @Value("${alert.discord.webhook-url}")
    private String webhookUrl;

    //localí™˜ê²½ì´ë©´ enabled:false, deví™˜ê²½ì´ë©´ enabled:true
    @Value("${alert.discord.enabled}")
    private boolean webhookEnabled;

    //Spring Frameworkì—ì„œ ì œê³µí•˜ëŠ” ë™ê¸°(Synchronous) ë°©ì‹ì˜ HTTP í´ë¼ì´ì–¸íŠ¸
    //ë‹¤ë¥¸ ì„œë²„ì˜ APIë¥¼ í˜¸ì¶œí•  ë•Œ ì‚¬ìš©
    private final RestTemplate restTemplate = new RestTemplate();

    public void sendErrorToWebhook(Exception ex, String url, String method) {
        try {
            if(webhookEnabled){
                String message = buildMessage(ex, url, method);

                //HTTP Header ì •ì˜, Content-Type: application/json
                HttpHeaders headers = new HttpHeaders();
                headers.setContentType(MediaType.APPLICATION_JSON);

                // Discord body í˜•ì‹({content: ë‚´ìš©})
                Map<String, String> payload = Map.of("content", message);

                //header + body
                HttpEntity<Map<String, String>> entity = new HttpEntity<>(payload, headers);

                //webhookUrlì— entityë‚´ìš©ì„ postë¡œ ì „ì†¡
                restTemplate.postForEntity(webhookUrl, entity, String.class);
            }

        } catch (Exception e) {
            log.error("Failed to send webhook: {}", e.getMessage());
        }
    }

    // Discordì— ë³´ë‚¼ ë©”ì‹œì§€ í˜•ì‹
    private String buildMessage(Exception ex, String url, String method) {
        return """
                ğŸš¨ **500 Internal Server Error ë°œìƒ**
                - URL: `%s`
                - Method: `%s`
                - ì˜ˆì™¸: `%s`
                - ì‹œê°: `%s`
                """.formatted(
                url,
                method,
                ex.getMessage(),
                LocalDateTime.now().format(DateTimeFormatter.ofPattern("yyyy-MM-dd HH:mm:ss"))
        );
    }

}

```

dev í™˜ê²½ (enabled: true)ì—ì„œë§Œ webhookì´ ì‘ë™ë˜ë„ë¡ ì„¤ì •í•œë‹¤.

ê°œë°œ ê³¼ì •ì—ì„œ ì—ëŸ¬ëŠ” ë¹ˆë²ˆí•˜ê²Œ ì¼ì–´ë‚œë‹¤.

ë¡œì»¬ ì„œë²„ì—ì„œ ì—ëŸ¬ê°€ ë°œìƒí•  ë•Œ ë§ˆë‹¤ ì•ŒëŒì´ ë°œìƒí•œë‹¤ë©´, ìˆ˜ë§ì€ ë¶ˆí•„ìš”í•œ ì•ŒëŒì´ ë°œìƒí•´ ì•ŒëŒì˜ ì¤‘ìš”ë„ë¥¼ ë‚®ê²Œ ì¸ì‹í•  ìˆ˜ ìˆë‹¤.